# Omega更新服务器存储管理策略

## 存储限制
- **总存储空间**: 40GB
- **系统占用**: ~10GB
- **可用存储**: ~30GB
- **完整包大小**: ~8GB (压缩后)
- **增量包大小**: 通常 <500MB

## 存储分配策略

### 1. 存储分区
```
/var/www/updates/
├── full/           # 完整包存储 (最大24GB, 3个版本)
├── patches/        # 增量包存储 (最大4GB)
├── hotfixes/       # 热修复包存储 (最大1GB)
└── temp/           # 临时文件 (最大1GB)
```

### 2. 版本保留策略

#### 完整包 (FULL)
- **最大数量**: 3个版本
- **保留规则**:
  - 最新稳定版本 (必须保留)
  - 最新测试版本 (如果存在)
  - 上一个稳定版本 (回滚备份)

#### 增量包 (PATCH)
- **最大数量**: 10个版本
- **保留规则**:
  - 最近10个版本的增量包
  - 优先保留稳定版本的增量包

#### 热修复包 (HOTFIX)
- **最大数量**: 20个版本
- **保留规则**:
  - 最近20个热修复包
  - 按时间自动清理

## 包类型定义

### 1. FULL (完整包)
- **用途**: 全新安装或大版本升级
- **大小**: ~8GB
- **包含**: 完整的应用程序文件
- **命名**: `omega-v{version}-full-{platform}-{arch}.zip`

### 2. PATCH (增量包)
- **用途**: 版本间的增量更新
- **大小**: 通常 <500MB
- **包含**: 变更的文件和更新脚本
- **命名**: `omega-v{from_version}-to-v{to_version}-patch-{platform}-{arch}.zip`

### 3. HOTFIX (热修复包)
- **用途**: 紧急bug修复
- **大小**: 通常 <100MB
- **包含**: 特定文件的修复
- **命名**: `omega-v{version}-hotfix-{fix_id}-{platform}-{arch}.zip`

## 自动清理策略

### 1. 触发条件 (优化版)
- 存储空间使用率 > 75% (降低阈值)
- 上传新版本时空间不足
- 定期清理 (每日凌晨2点和下午2点)
- 手动触发清理

### 2. 清理优先级 (从高到低)
1. 临时文件和上传失败的文件
2. 超过保留数量的热修复包
3. 超过保留数量的增量包
4. 非关键的测试版本完整包
5. 最旧的稳定版本完整包 (保留最少1个)

### 3. 保护规则
- 永不删除最新稳定版本
- 永不删除标记为"关键"的版本
- 删除前创建备份清单

## 存储监控

### 1. 监控指标
- 总存储使用率
- 各类型包的存储使用情况
- 版本数量统计
- 清理历史记录

### 2. 告警阈值
- **警告**: 存储使用率 > 80%
- **严重**: 存储使用率 > 90%
- **紧急**: 存储使用率 > 95%

### 3. 监控API
```
GET /api/v1/storage/stats     # 存储统计
GET /api/v1/storage/cleanup   # 执行清理
GET /api/v1/storage/history   # 清理历史
```

## 实施计划

### 阶段1: 数据库扩展
- 扩展Version表支持包类型
- 添加存储管理相关字段
- 创建清理历史表

### 阶段2: 存储管理实现
- 实现存储空间监控
- 实现自动清理逻辑
- 添加存储管理API

### 阶段3: 上传功能增强
- 修改上传API支持包类型
- 添加存储空间检查
- 实现智能清理

### 阶段4: GUI工具
- 创建高级上传工具
- 添加存储管理界面
- 实现版本管理功能

## 配置参数

```python
STORAGE_CONFIG = {
    "max_total_size": 30 * 1024 * 1024 * 1024,  # 30GB
    "max_full_packages": 3,
    "max_patch_packages": 15,  # 增加增量包保留数量
    "max_hotfix_packages": 30,  # 增加热修复包保留数量
    "cleanup_threshold": 0.75,  # 75% (优化)
    "warning_threshold": 0.70,  # 70% (优化)
    "critical_threshold": 0.85, # 85% (优化)
    "temp_retention_hours": 12,  # 减少临时文件保留时间
    "cleanup_schedule": "0 2,14 * * *",  # 每日2次清理
    "monitoring_schedule": "0 * * * *"   # 每小时监控
}
```

## 风险控制

### 1. 数据安全
- 删除前验证文件完整性
- 保留删除日志
- 支持紧急恢复

### 2. 服务可用性
- 清理过程不影响下载服务
- 分批清理避免IO压力
- 失败重试机制

### 3. 回滚支持
- 保留关键版本用于回滚
- 维护版本依赖关系
- 支持快速版本切换

## 存储优化实施记录

### 2024年7月优化成果
- **清理测试文件**: 释放1GB空间
- **优化清理阈值**: 从85%降低到75%
- **增强监控频率**: 从每日1次增加到每小时监控
- **自动化清理**: 部署定时清理脚本
- **当前使用率**: 9% (3.3GB/40GB)

### 实施的优化措施
1. **积极清理策略**
   - 警告阈值: 70% (原80%)
   - 清理阈值: 75% (原85%)
   - 紧急阈值: 85% (原90%)

2. **自动化监控**
   - 每小时存储监控
   - 每日2次自动清理 (2:00, 14:00)
   - 每周系统级清理 (周日6:00)

3. **优化配置**
   - 临时文件保留时间: 12小时 (原24小时)
   - 增量包保留数量: 15个 (原10个)
   - 热修复包保留数量: 30个 (原20个)
