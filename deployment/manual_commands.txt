# Omega更新服务器手动部署命令
# 请按顺序复制粘贴以下命令到PowerShell中执行

# ===== 第一步：上传文件 =====
# 创建远程目录
ssh -o "PreferredAuthentications=password" root@106.14.28.97 "rm -rf /tmp/omega-deployment && mkdir -p /tmp/omega-deployment"

# 上传部署脚本
scp -o "PreferredAuthentications=password" deployment\deploy.sh root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" deployment\diagnose.sh root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" deployment\fix_common_issues.sh root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" deployment\fix_server_limits.sh root@106.14.28.97:/tmp/omega-deployment/

# 上传配置文件
scp -o "PreferredAuthentications=password" deployment\main.py root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" deployment\server_config.py root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" deployment\nginx.conf root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" deployment\omega-update-server.service root@106.14.28.97:/tmp/omega-deployment/

# 上传工具脚本
scp -o "PreferredAuthentications=password" deployment\simple_package_maker.py root@106.14.28.97:/tmp/omega-deployment/

# 上传项目文件
scp -o "PreferredAuthentications=password" -r update_server root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" generate_update_package.py root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" simple_update_generator.py root@106.14.28.97:/tmp/omega-deployment/
scp -o "PreferredAuthentications=password" version_analyzer.py root@106.14.28.97:/tmp/omega-deployment/

# 设置文件权限
ssh -o "PreferredAuthentications=password" root@106.14.28.97 "chmod +x /tmp/omega-deployment/*.sh"

# ===== 第二步：连接服务器并部署 =====
# 连接到服务器
ssh -o "PreferredAuthentications=password" root@106.14.28.97

# 在服务器上执行以下命令：
cd /tmp/omega-deployment
ls -la  # 检查文件是否上传成功

# 修复服务器文件大小限制
./fix_server_limits.sh

# 检查服务状态
./diagnose.sh

# 如果有问题，运行修复
./fix_common_issues.sh

# ===== 第三步：验证部署 =====
# 检查服务状态
systemctl status omega-update-server nginx

# 测试HTTP接口
curl http://localhost/health

# 查看日志
tail -f /var/log/omega-updates/server.log
