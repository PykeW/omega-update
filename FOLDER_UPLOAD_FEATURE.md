# 文件夹上传功能说明

## 功能概述

Omega更新服务器现在支持直接上传文件夹，无需手动压缩。系统会自动分析文件夹内容、压缩为ZIP格式并上传到服务器。

## 主要改进

### 1. 从文件上传改为文件夹上传

#### 之前的方式
- 用户需要手动将文件夹压缩为ZIP文件
- 选择压缩包文件进行上传
- 无法预览文件夹内容

#### 现在的方式
- 直接选择文件夹进行上传
- 系统自动分析文件夹结构
- 自动压缩并上传
- 提供文件夹内容预览功能

### 2. 新增功能特性

#### 文件夹分析
- 递归扫描文件夹中的所有文件
- 统计文件数量和总大小
- 按文件扩展名分类统计
- 实时显示分析结果

#### 内容预览
- 显示文件夹基本信息（路径、文件数、总大小）
- 按文件类型统计显示
- 树形结构展示文件分布

#### 智能压缩
- 自动创建临时ZIP文件
- 保持原始文件夹结构
- 使用ZIP_DEFLATED压缩算法
- 压缩级别设置为6（平衡压缩率和速度）

#### 进度显示
- 独立的进度窗口
- 压缩进度实时显示
- 上传进度实时显示
- 支持取消操作

## 界面变化

### 文件选择区域
```
之前: [文件路径输入框] [选择文件]
现在: [文件夹路径输入框] [选择文件夹] [预览内容]
```

### 新增控件
- **选择文件夹按钮**: 打开文件夹选择对话框
- **预览内容按钮**: 显示文件夹内容预览窗口
- **文件夹信息标签**: 显示文件数量和总大小

### 进度窗口
- 模态对话框显示处理进度
- 进度条显示压缩和上传进度
- 状态标签显示当前操作
- 取消按钮允许中断操作

## 技术实现

### 核心方法

#### `select_folder()`
```python
def select_folder(self):
    """选择文件夹"""
    folder_path = filedialog.askdirectory(title="选择要上传的文件夹")
    if folder_path:
        self.selected_folder.set(folder_path)
        self.analyze_folder(folder_path)
```

#### `analyze_folder()`
```python
def analyze_folder(self, folder_path):
    """分析文件夹内容"""
    # 递归扫描所有文件
    # 统计文件数量、大小、类型
    # 保存分析结果到 self.folder_analysis
```

#### `create_zip_from_folder()`
```python
def create_zip_from_folder(self, folder_path, progress_callback=None):
    """将文件夹压缩为zip文件"""
    # 创建临时ZIP文件
    # 递归添加所有文件
    # 保持目录结构
    # 调用进度回调
```

#### `upload_package()` (重构)
```python
def upload_package(self):
    """上传包"""
    # 验证文件夹选择
    # 创建进度窗口
    # 压缩文件夹
    # 上传ZIP文件
    # 清理临时文件
```

### 文件处理流程

1. **选择文件夹** → 用户通过对话框选择文件夹
2. **分析内容** → 系统递归扫描文件夹，统计信息
3. **显示预览** → 用户可查看文件夹结构和统计信息
4. **开始上传** → 用户点击上传按钮
5. **创建进度窗口** → 显示处理进度
6. **压缩文件夹** → 创建临时ZIP文件，显示压缩进度
7. **上传文件** → 上传ZIP到服务器，显示上传进度
8. **清理临时文件** → 删除临时ZIP文件
9. **完成** → 关闭进度窗口，显示结果

### 错误处理

- 文件夹不存在或无权限访问
- 压缩过程中的文件读取错误
- 网络连接问题
- 服务器响应错误
- 用户取消操作

## 使用指南

### 基本操作流程

1. **启动程序**
   ```bash
   python advanced_upload_gui.py
   ```

2. **选择文件夹**
   - 点击"选择文件夹"按钮
   - 在对话框中选择要上传的文件夹
   - 系统自动分析文件夹内容

3. **预览内容**（可选）
   - 点击"预览内容"按钮
   - 查看文件夹结构和统计信息
   - 确认文件内容正确

4. **配置上传参数**
   - 选择包类型（完整包/增量包/热修复包）
   - 输入目标版本号
   - 选择平台和架构
   - 填写描述信息

5. **开始上传**
   - 点击"上传"按钮
   - 观察进度窗口中的处理进度
   - 等待上传完成

### 注意事项

- 确保文件夹中不包含敏感信息
- 大文件夹可能需要较长的压缩时间
- 网络不稳定时建议分批上传
- 上传过程中不要关闭程序

## 性能优化

### 压缩优化
- 使用ZIP_DEFLATED算法
- 压缩级别设置为6（平衡性能）
- 分块读取大文件避免内存溢出

### 界面优化
- 异步处理避免界面冻结
- 实时进度反馈提升用户体验
- 支持取消操作

### 内存管理
- 及时清理临时文件
- 使用上下文管理器确保文件正确关闭
- 分块处理大文件

## 兼容性

### 向后兼容
- 服务器端无需修改，仍接收ZIP文件
- 现有API接口保持不变
- 数据库结构无变化

### 系统要求
- Python 3.7+
- tkinter GUI库
- zipfile标准库
- pathlib标准库

## 测试验证

所有功能都通过了自动化测试：
- ✅ 文件夹分析功能
- ✅ ZIP压缩功能  
- ✅ GUI组件完整性
- ✅ 进度回调机制
- ✅ 错误处理机制

## 未来扩展

### 可能的改进方向
- 支持排除特定文件类型
- 添加压缩选项配置
- 支持增量压缩
- 添加文件完整性校验
- 支持断点续传

### 高级功能
- 文件夹对比功能
- 自动版本检测
- 批量文件夹处理
- 云存储集成

---

**版本**: 2.1.0  
**更新日期**: 2025-07-13  
**兼容性**: 完全向后兼容，服务器端无需修改
